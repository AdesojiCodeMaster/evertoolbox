<!--
<!doctype html><html lang='en'><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="EverToolbox â€” fast, free, and elegant web utilities for creators.">
<!-- GA4 placeholder: G-XXXXXXXXXX -->
<!-- Search Console verification placeholder --><title>File Converter â€” EverToolbox</title><link rel='stylesheet' href='style.css'></head><body><header id="site-header" class="site-header" role="banner">

  <!--
  <div class="container header-inner">
    <a class="brand" href="index.html" aria-label="EverToolbox home">
      <div class="logo">ET</div>
      <div class="brand-text"><span class="brand-name">EverToolbox</span><small class="muted">Smart web utilities</small></div>
    </a>
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <ul class="nav-list">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="tools.html">Tools</a></li>
        <li><a href="blog.html">Blog</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
    <div class="header-actions">
      <button id="theme-toggle" class="toggle" aria-label="Toggle theme">ðŸŒ™</button>
      <button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="Open menu" aria-expanded="false">â˜°</button>
    </div>
  </div>
</header>
<nav id="mobile-menu" class="mobile-menu" aria-hidden="true">
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="about.html">About</a></li>
    <li><a href="tools.html">Tools</a></li>
    <li><a href="blog.html">Blog</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>
</nav>
  <main class='container'>
    <article class='card'>
      <h1>File Converter & Compressor</h1>
<!-- ================= FILE CONVERTER TOOL START ================= -->
  <!-- ==============================
     FILE CONVERTER + COMPRESSOR
     ============================== -->
<!--
<section id="file-converter-tool" class="tool-section">
<h2 class="tool-subtitle">Easily convert or compress files directly in your browser.</h2> -->
 <!-- ==========================================================
     EverToolbox File Converter & Compressor
     Global Standard Version - Responsive, Polished, Functional
========================================================== -->
<!--
  <div class="tool-container">
    <h2>File Converter & Compressor</h2>
    <p class="tool-subtitle">
      Convert or compress your documents and images quickly and securely.
    </p>

    <form id="fileToolForm" onsubmit="return false;">
      <div class="form-group">
        <label for="fileInput">Choose file:</label>
        <input type="file" id="fileInput" required />
      </div>

      <div class="form-group">
        <label for="outputFormat">Convert to:</label>
        <select id="outputFormat">
          <option value="">Select format</option>
          <option value="pdf">PDF</option>
          <option value="jpg">JPG</option>
          <option value="png">PNG</option>
          <option value="txt">TXT</option>
          <option value="docx">DOCX</option>
        </select>
      </div>

      <div class="form-group">
        <label for="watermark">Watermark (optional):</label>
        <input type="text" id="watermark" placeholder="Enter text watermark" />
      </div>

      <div class="form-group">
        <label for="renameTo">Rename to (optional):</label>
        <input type="text" id="renameTo" placeholder="e.g. newfile.pdf" />
      </div>

      <div class="button-group">
        <button class="btn primary" id="convert-btn" onclick="handleFile('convert')">Start Conversion</button>
         
        <button  class="btn secondary"   id="compress-btn" onclick="handleFile('compress')">Compress File</button>
          

      </div>
    </form>

    <div id="statusArea" class="status hidden">
      <div class="spinner"></div>
      <p id="statusText">Processing your file...</p>
    </div>

    <div id="resultArea" class="result hidden">
      <h3>Result</h3>
      <p id="fileInfo"></p>
      <a id="downloadLink" href="#" class="btn download">Download File</a>
    </div>
  </div>


<script>
const API_BASE_URL = "https://evertoolbox-backend.onrender.com";

async function handleFile(action) {
  const fileInput = document.getElementById("fileInput");
  const outputFormat = document.getElementById("outputFormat");
  const watermark = document.getElementById("watermark");
  const renameTo = document.getElementById("renameTo");
  const statusArea = document.getElementById("statusArea");
  const statusText = document.getElementById("statusText");
  const resultArea = document.getElementById("resultArea");
  const fileInfo = document.getElementById("fileInfo");
  const downloadLink = document.getElementById("downloadLink");

  if (!fileInput.files.length) return alert("Please select a file first.");

  resultArea.classList.add("hidden");
  statusArea.classList.remove("hidden");
  statusText.textContent = "Processing your file...";

  const file = fileInput.files[0];
  const form = new FormData();
  form.append("file", file);
  form.append("renameTo", renameTo.value || "");
  form.append("watermark", watermark.value || "");
  if (action === "convert") {
    if (!outputFormat.value) {
      alert("Please choose an output format.");
      statusArea.classList.add("hidden");
      return;
    }
    form.append("outputFormat", outputFormat.value);
  }

  const endpoint =
    action === "convert"
      ? `${API_BASE_URL}/api/v3/file/convert`
      : `${API_BASE_URL}/api/v3/file/compress`;

  try {
    const res = await fetch(endpoint, { method: "POST", body: form });
    if (!res.ok) throw new Error("Error processing the file.");

    const blob = await res.blob();
    const filename =
      renameTo.value ||
      (action === "convert"
        ? file.name.replace(/\.[^/.]+$/, "") + "." + outputFormat.value
        : file.name);

    const downloadUrl = URL.createObjectURL(blob);
    downloadLink.href = downloadUrl;
    downloadLink.download = filename;
    fileInfo.textContent = `${filename} â€” ${(blob.size / 1024).toFixed(1)} KB`;

    statusArea.classList.add("hidden");
    resultArea.classList.remove("hidden");
  } catch (err) {
    console.error(err);
    statusArea.classList.add("hidden");
    alert("Error processing the file. Please try again.");
  }
}
</script>

<style>
/* ========== Global Tool Styling (EverToolbox Theme) ========== */
#evertoolbox-file-tool {
  background: #ffffff;
  border-radius: 16px;
  max-width: 650px;
  margin: 30px auto;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  font-family: "Inter", system-ui, sans-serif;
}
.tool-container {
  padding: 25px 20px 30px;
}
#evertoolbox-file-tool h2 {
  text-align: center;
  color: #1e40af;
  font-size: 1.8rem;
  margin-bottom: 6px;
}
.tool-subtitle {
  text-align: center;
  color: #6b7280;
  font-size: 0.95rem;
  margin-bottom: 20px;
}
.form-group {
  margin-bottom: 15px;
}
.form-group label {
  display: block;
  font-weight: 600;
  color: #111827;
  margin-bottom: 6px;
}
input[type="file"],
select,
input[type="text"] {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  font-size: 0.95rem;
  outline: none;
  transition: border 0.2s;
}
input[type="file"]:focus,
select:focus,
input[type="text"]:focus {
  border-color: #2563eb;
}
.button-group {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 20px;
}
.btn {
  padding: 10px 18px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.3s ease;
  font-size: 0.95rem;
}
.btn.primary {
  background: #1e40af;
  color: #fff;
}
.btn.secondary {
  background: #2563eb;
  color: #fff;
}
.btn.download {
  background: #1e3a8a;
  display: inline-block;
  text-decoration: none;
  margin-top: 10px;
}
.btn:hover {
  opacity: 0.9;
}
.status {
  text-align: center;
  margin-top: 20px;
  color: #374151;
}
.spinner {
  width: 30px;
  height: 30px;
  border: 4px solid #d1d5db;
  border-top: 4px solid #2563eb;
  border-radius: 50%;
  margin: 0 auto 10px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
.result {
  text-align: center;
  margin-top: 25px;
  padding-top: 10px;
  border-top: 1px solid #e5e7eb;
}
.hidden {
  display: none !important;
}
@media (max-width: 640px) {
  #evertoolbox-file-tool {
    margin: 15px;
  }
  .btn {
    flex: 1;
    font-size: 0.9rem;
  }
}
      </style>
  

  
  

    </section>
   </article>
  </main>
  <footer id="site-footer" class="site-footer" role="contentinfo">
  <div class="container footer-inner">
    <div class="footer-left">
      <strong>EverToolbox</strong><br><small class="muted">Â© 2025 EverToolbox. All rights reserved.</small>
    </div>
    <div class="footer-right">
      <a href="https://github.com/AdesojiCodeMaster" target="_blank" rel="noopener">GitHub</a>
      <a href="https://www.linkedin.com/in/adesoji-adewumi" target="_blank" rel="noopener">LinkedIn</a>
      <a href="https://twitter.com/codemas22665735" target="_blank" rel="noopener">Twitter</a>
    </div>
  </div>
</footer>
  <script src='script.js'> </script>  
</body>
</html> 
-->



<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EverToolbox â€” File Converter Â· Compressor Â· Editor</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  /* ---------- Theme & Layout ---------- */
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa7bf; --accent:#06b6d4; --accent-2:#7c3aed;
    --glass: rgba(255,255,255,0.03);
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071428,#071a2b);font-family:Inter,ui-sans-serif,system-ui,Arial;color:#e6eef8;padding:28px;display:flex;align-items:flex-start;justify-content:center}
  .wrap{width:100%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:var(--radius);padding:20px;box-shadow:0 10px 40px rgba(2,6,23,0.6)}
  h1{margin:0 0 6px;color:var(--accent);font-size:20px}
  p.lead{margin:0 0 18px;color:var(--muted);font-size:13px}

  .grid{display:grid;grid-template-columns:380px 1fr;gap:18px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  /* left panel */
  .panel{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .drop{border:2px dashed rgba(255,255,255,0.04);padding:12px;border-radius:10px;text-align:center;cursor:pointer;transition:all .18s}
  .drop.drag{background:rgba(255,255,255,0.02);transform:translateY(-2px)}
  .small{font-size:13px;color:var(--muted)}
  input[type=file]{display:none}

  label.select,label.input{display:block;margin-top:10px}
  select,input[type=number],input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
  .row{display:flex;gap:8px;margin-top:10px}
  button{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;color:#042a2e;padding:9px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

  /* right panel */
  .stage{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;min-height:360px}
  canvas{max-width:100%;border-radius:8px;display:block;background:#03121a}
  .preview-media{max-width:100%;border-radius:8px;display:block}
  .meta{margin-top:8px;color:var(--muted);font-size:13px}

  .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin-top:12px;display:none}
  .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#06b6d4,#7c3aed);transition:width .2s}

  .message{margin-top:10px;color:var(--muted);font-size:13px}
  .error{margin-top:10px;color:#ffb4b4;font-weight:600}
  .success{margin-top:10px;color:#9fe8c6;font-weight:700}

  .control-row{display:flex;gap:8px;align-items:center;margin-top:10px}
  .small-muted{font-size:12px;color:var(--muted)}
  footer{margin-top:16px;text-align:center;font-size:12px;color:rgba(255,255,255,0.45)}
</style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>EverToolbox â€” File Converter Â· Compressor Â· Editor</h1>
    <p class="lead">Drop a file, preview and optionally edit images, then Convert or Compress. Supports images, audio, video, text & documents. One file at a time.</p>

    <div class="grid">
      <!-- LEFT: controls -->
      <div class="panel">
        <div id="dropZone" class="drop" tabindex="0">
          <div id="dropText">Click or drop one file here</div>
          <input id="fileInput" type="file" accept="*/*" />
          <div class="small" style="margin-top:8px">Single file only â€¢ Max size enforced by server</div>
        </div>

        <label class="select">Target format
          <select id="targetFormat" aria-label="target format">
            <option value="">â€” keep original â€”</option>
            <optgroup label="Images">
              <option value="jpeg">JPG / JPEG</option><option value="png">PNG</option><option value="webp">WEBP</option><option value="avif">AVIF</option><option value="svg">SVG</option>
            </optgroup>
            <optgroup label="Documents">
              <option value="pdf">PDF</option><option value="txt">TXT</option><option value="docx">DOCX</option><option value="html">HTML</option><option value="md">Markdown</option>
            </optgroup>
            <optgroup label="Audio">
              <option value="mp3">MP3</option><option value="wav">WAV</option><option value="ogg">OGG</option>
            </optgroup>
            <optgroup label="Video">
              <option value="mp4">MP4</option><option value="webm">WEBM</option>
            </optgroup>
          </select>
        </label>

        <div class="row">
          <label class="input" style="flex:1">Quality (1â€“100)
            <input id="quality" type="number" min="1" max="100" value="80" />
          </label>
          <label class="input" style="width:120px">Resize W
            <input id="width" type="number" placeholder="px" />
          </label>
        </div>

        <label class="input">Resize H
          <input id="height" type="number" placeholder="px" />
        </label>

        <div style="margin-top:12px;font-size:13px;color:var(--muted)">Image editor (client-side): rotate, crop, brightness/contrast, overlay text. Edits applied before upload.</div>

        <div class="control-row">
          <button id="openEditor" class="ghost">Open Editor</button>
          <button id="convertBtn">Convert</button>
          <button id="compressBtn">Compress</button>
          <button id="clearBtn" class="ghost">Clear</button>
        </div>

        <div class="progress" id="progress"><i id="bar"></i></div>
        <div class="message" id="message"></div>
        <div class="error" id="error" role="alert"></div>
        <div class="success" id="success" role="status"></div>
      </div>

      <!-- RIGHT: preview / editor stage -->
      <div class="stage panel">
        <div id="stageArea">
          <canvas id="canvas" style="display:none"></canvas>
          <div id="mediaPreview"></div>
          <div class="meta" id="metaInfo"></div>
        </div>

        <!-- Editor controls modal-ish area (client-side) -->
        <div id="editorControls" style="margin-top:12px;display:none;">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <label class="small-muted">Rotate
              <input id="rotate" type="number" value="0" style="width:100px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)">
            </label>

            <label class="small-muted">Crop (left,top,w,h)
              <input id="crop" type="text" placeholder="e.g. 10,10,200,200" style="min-width:180px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)">
            </label>

            <label class="small-muted">Brightness
              <input id="brightness" type="number" min="0" max="3" step="0.1" value="1" style="width:100px">
            </label>
            <label class="small-muted">Contrast
              <input id="contrast" type="number" min="0" max="3" step="0.1" value="1" style="width:100px">
            </label>

            <label class="small-muted">Overlay text
              <input id="overlayText" type="text" placeholder="Optional text" style="min-width:180px">
            </label>

            <button id="applyEdits" class="ghost">Apply Edits</button>
            <button id="resetEdits" class="ghost">Reset Edits</button>
          </div>
        </div>
      </div>
    </div>

    <footer>EverToolbox â€” elegant â€¢ fast â€¢ reliable</footer>
  </div>

<script>
/* ========== CONFIG ========== */
const BACKEND_HOST = 'https://evertoolbox-backend.onrender.com';
const ENDPOINT_CONVERT = BACKEND_HOST + '/api/tools/file/convert';
const ENDPOINT_COMPRESS = BACKEND_HOST + '/api/tools/file/compress';
const ENDPOINT_PROCESS = BACKEND_HOST + '/api/tools/file/process'; // fallback if convert/compress not present

/* ========== UI refs ========== */
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const dropText = document.getElementById('dropText');
const targetFormat = document.getElementById('targetFormat');
const qualityEl = document.getElementById('quality');
const widthEl = document.getElementById('width');
const heightEl = document.getElementById('height');
const convertBtn = document.getElementById('convertBtn');
const compressBtn = document.getElementById('compressBtn');
const clearBtn = document.getElementById('clearBtn');
const openEditor = document.getElementById('openEditor');
const messageEl = document.getElementById('message');
const errorEl = document.getElementById('error');
const successEl = document.getElementById('success');
const progress = document.getElementById('progress');
const bar = document.getElementById('bar');
const mediaPreview = document.getElementById('mediaPreview');
const metaInfo = document.getElementById('metaInfo');
const canvas = document.getElementById('canvas');
const editorControls = document.getElementById('editorControls');
const rotateEl = document.getElementById('rotate');
const cropEl = document.getElementById('crop');
const brightnessEl = document.getElementById('brightness');
const contrastEl = document.getElementById('contrast');
const overlayTextEl = document.getElementById('overlayText');
const applyEditsBtn = document.getElementById('applyEdits');
const resetEditsBtn = document.getElementById('resetEdits');

/* ========== State ========== */
let selectedFile = null;
let processedBlob = null;
let lastDownloadURL = null;
let imageObj = new Image();
let originalImageURL = null;
let editsState = { rotate:0, crop:null, brightness:1, contrast:1, text:null };

/* ========== Helpers ========== */
function showMessage(txt){ messageEl.textContent = txt; errorEl.textContent = ''; successEl.textContent = ''; }
function showError(txt){ errorEl.textContent = txt; messageEl.textContent = ''; successEl.textContent = ''; }
function showSuccess(txt){ successEl.textContent = txt; messageEl.textContent = ''; errorEl.textContent = ''; }
function setProgress(pct){ progress.style.display = (pct===0||pct>=100)?'none':'block'; bar.style.width = pct+'%'; if(pct>=100) setTimeout(()=>progress.style.display='none',300) }
function clearPreview(){ mediaPreview.innerHTML=''; metaInfo.textContent=''; canvas.style.display='none'; editorControls.style.display='none'; if(originalImageURL){ URL.revokeObjectURL(originalImageURL); originalImageURL=null } }

/* ---------- Drag & Drop + input ---------- */
dropZone.addEventListener('click', ()=>fileInput.click());
dropZone.addEventListener('dragover', e=>{ e.preventDefault(); dropZone.classList.add('drag'); });
dropZone.addEventListener('dragleave', ()=>dropZone.classList.remove('drag'));
dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('drag'); if(e.dataTransfer.files && e.dataTransfer.files[0]) handleFileSelect(e.dataTransfer.files[0]); });

fileInput.addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) handleFileSelect(e.target.files[0]); });

clearBtn.addEventListener('click', ()=>{
  selectedFile = null; processedBlob = null; lastDownloadURL && URL.revokeObjectURL(lastDownloadURL); lastDownloadURL=null;
  fileInput.value=''; clearPreview(); dropText.textContent='Click or drop one file here'; showMessage('Cleared.');
});

/* ---------- File selection & preview ---------- */
function handleFileSelect(f){
  // accept single file only
  selectedFile = f;
  dropText.textContent = f.name;
  clearPreview();
  processedBlob = null;
  showMessage('File selected: '+f.name);

  const t = f.type || '';
  metaInfo.textContent = `Size: ${(f.size/1024|0)} KB â€¢ Type: ${t||'unknown'}`;

  if (t.startsWith('image/')) {
    const url = URL.createObjectURL(f);
    originalImageURL = url;
    imageObj = new Image();
    imageObj.onload = ()=> { renderImageToCanvas(imageObj); canvas.style.display = 'block'; editorControls.style.display = 'block'; mediaPreview.innerHTML = `<img class="preview-media" src="${url}" alt="image preview">`; }
    imageObj.onerror = ()=> { mediaPreview.innerHTML = `<div class="small">Could not preview image</div>`; }
    imageObj.src = url;
  } else if (t === 'application/pdf') {
    const url = URL.createObjectURL(f);
    mediaPreview.innerHTML = `<embed src="${url}" type="application/pdf" width="100%" height="380px">`;
  } else if (t.startsWith('audio/')) {
    const url = URL.createObjectURL(f);
    mediaPreview.innerHTML = `<audio controls class="preview-media" src="${url}"></audio>`;
  } else if (t.startsWith('video/')) {
    const url = URL.createObjectURL(f);
    mediaPreview.innerHTML = `<video controls class="preview-media" src="${url}"></video>`;
  } else {
    // attempt to show text preview for small files
    if (f.size < 200000) {
      const reader = new FileReader();
      reader.onload = () => mediaPreview.innerHTML = `<pre style="white-space:pre-wrap;color:var(--muted);font-size:13px">${escapeHtml(reader.result)}</pre>`;
      reader.onerror = ()=> mediaPreview.innerHTML = `<div class="small">Cannot preview</div>`;
      reader.readAsText(f);
    } else {
      mediaPreview.innerHTML = `<div class="small">Selected: ${f.name}</div>`;
    }
  }
}

/* ---------- Image canvas utilities (client-side editing) ---------- */
function renderImageToCanvas(img){
  const maxW = 1200;
  const maxH = 800;
  let iw = img.naturalWidth || img.width;
  let ih = img.naturalHeight || img.height;
  const scale = Math.min(1, maxW/iw, maxH/ih);
  const cw = Math.round((widthEl.value?parseInt(widthEl.value):Math.round(iw*scale))||Math.round(iw*scale));
  const ch = Math.round((heightEl.value?parseInt(heightEl.value):Math.round(ih*scale))||Math.round(ih*scale));
  canvas.width = cw; canvas.height = ch;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,cw,ch);
  // apply rotation + transforms in draw function
  // call draw with current edits
  drawCanvasWithEdits();
}

function drawCanvasWithEdits(){
  if(!imageObj.src) return;
  const ctx = canvas.getContext('2d');
  const cw = canvas.width, ch = canvas.height;
  ctx.save();
  ctx.clearRect(0,0,cw,ch);
  // translate center for rotation
  const rot = (editsState.rotate||0) * Math.PI/180;
  ctx.translate(cw/2, ch/2);
  ctx.rotate(rot);
  ctx.translate(-cw/2, -ch/2);
  // draw image scaled to canvas size (fit)
  ctx.drawImage(imageObj, 0, 0, cw, ch);
  // apply brightness/contrast via canvas globalComposite? use filter if supported
  ctx.restore();
  // apply CSS filter fallback using an offscreen canvas (simple approach)
  // Instead we will fake brightness/contrast by drawing overlay (quick), but for production use advanced filter libraries
  if (editsState.brightness != 1 || editsState.contrast != 1) {
    // simple brightness adjustment
    const imageData = ctx.getImageData(0,0,cw,ch);
    const data = imageData.data;
    const b = editsState.brightness || 1;
    const c = editsState.contrast || 1;
    // contrast adjust center
    const factor = (259 * (c * 255 + 255)) / (255 * (259 - c * 255));
    for (let i=0;i<data.length;i+=4){
      for (let j=0;j<3;j++){
        let v = data[i+j];
        v = v * b;
        v = factor * (v - 128) + 128;
        data[i+j] = Math.max(0, Math.min(255, v));
      }
    }
    ctx.putImageData(imageData, 0,0);
  }
  // crop overlay (visual)
  if (editsState.crop) {
    const c = editsState.crop;
    ctx.strokeStyle = 'yellow'; ctx.lineWidth=2;
    ctx.strokeRect(c.left, c.top, c.width, c.height);
  }
  // overlay text
  if (editsState.text) {
    ctx.fillStyle = editsState.text.color || '#fff';
    ctx.font = `${editsState.text.size||36}px sans-serif`;
    ctx.fillText(editsState.text.value, editsState.text.x||20, editsState.text.y||50);
  }
}

/* apply edits from inputs to state */
applyEditsBtn.addEventListener('click', ()=>{
  editsState.rotate = parseFloat(rotateEl.value||0);
  const cropVal = (cropEl.value||'').trim();
  editsState.crop = null;
  if (cropVal){
    const parts = cropVal.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n));
    if (parts.length===4) editsState.crop = { left:parts[0], top:parts[1], width:parts[2], height:parts[3] };
  }
  editsState.brightness = parseFloat(brightnessEl.value||1);
  editsState.contrast = parseFloat(contrastEl.value||1);
  const txt = (overlayTextEl.value||'').trim();
  editsState.text = txt ? { value: txt, x:20, y:40, size:parseInt(document.getElementById('overlayText').dataset.size||36), color:'#fff' } : null;
  drawCanvasWithEdits();
  showMessage('Edits applied in preview.');
});

/* reset edits */
resetEditsBtn.addEventListener('click', ()=>{
  editsState = { rotate:0, crop:null, brightness:1, contrast:1, text:null };
  rotateEl.value='0'; cropEl.value=''; brightnessEl.value='1'; contrastEl.value='1'; overlayTextEl.value='';
  drawCanvasWithEdits();
  showMessage('Edits reset.');
});

/* Open editor toggles editor controls */
openEditor.addEventListener('click', ()=>{
  if (!selectedFile) return showError('Select an image first to edit.');
  if (!selectedFile.type.startsWith('image/')) return showError('Editor only supports images.');
  editorControls.style.display = editorControls.style.display === 'none' ? 'block' : 'none';
});

/* ---------- Upload / Convert / Compress flow ---------- */
convertBtn.addEventListener('click', ()=> runAction('convert'));
compressBtn.addEventListener('click', ()=> runAction('compress'));

async function runAction(action){
  if (!selectedFile) return showError('Please select a file first.');
  clearMessages();
  // Build payload: if image and edits applied, send canvas blob; otherwise, send file
  let blobToSend = selectedFile;
  let filenameToSend = selectedFile.name;
  if (selectedFile.type.startsWith('image/') && canvas.style.display !== 'none') {
    // take crop if present
    let uploadBlob = await getEditedImageBlob();
    if (uploadBlob) { blobToSend = uploadBlob; filenameToSend = (selectedFile.name.replace(/\.[^/.]+$/,'') || 'image') + '.' + (targetFormat.value || selectedFile.name.split('.').pop()); }
  }

  // assemble FormData fields to match backend expectations
  const fd = new FormData();
  fd.append('file', blobToSend, filenameToSend);
  fd.append('action', action);
  if (targetFormat.value) fd.append('targetFormat', targetFormat.value);
  fd.append('quality', String(Math.max(1, Math.min(100, parseInt(qualityEl.value||80)))));

  // choose endpoint: prefer explicit convert/compress endpoints if available; fall back to /process
  const endpoint = (action==='convert') ? ENDPOINT_CONVERT : (action==='compress') ? ENDPOINT_COMPRESS : ENDPOINT_PROCESS;

  try {
    setProgressVisible(true); setProgress(5);
    showMessage(action === 'convert' ? 'Converting...' : 'Compressing...');
    const xhr = new XMLHttpRequest();
    xhr.open('POST', endpoint, true);
    xhr.responseType = 'blob';
    xhr.timeout = 5 * 60 * 1000; // 5 min

    xhr.upload.onprogress = (e)=> { if (e.lengthComputable) { const p = Math.round((e.loaded/e.total)*60); setProgress(p); } };
    xhr.onprogress = (e) => { if(e.lengthComputable) { const p = 60 + Math.round((e.loaded/e.total)*40); setProgress(p); } };

    xhr.onload = async () => {
      setProgress(100);
      try { setTimeout(()=>setProgressVisible(false),200); } catch(e){}
      if (xhr.status >= 200 && xhr.status < 300){
        // success â€” save blob and trigger download
        const contentDisposition = xhr.getResponseHeader('Content-Disposition') || '';
        let outName = guessOutputFilename(filenameToSend, targetFormat.value, contentDisposition);
        const outBlob = xhr.response;
        lastDownloadURL && URL.revokeObjectURL(lastDownloadURL);
        lastDownloadURL = URL.createObjectURL(outBlob);
        downloadBlob(lastDownloadURL, outName);
        processedBlob = outBlob;
        showSuccess('Done â€” download started.');
      } else {
        // try parse JSON from blob
        const txt = await blobToText(xhr.response);
        try {
          const j = JSON.parse(txt);
          showError(j.error || ('Server error ' + xhr.status));
        } catch(e){
          showError('Server returned error: ' + xhr.status);
        }
      }
    };

    xhr.onerror = ()=> { setProgressVisible(false); showError('Network or CORS error.'); };
    xhr.ontimeout = ()=> { setProgressVisible(false); showError('Request timed out. Try smaller file.'); };
    xhr.send(fd);
  } catch(err){
    showError('Upload failed: ' + (err && err.message ? err.message : String(err)));
    setProgressVisible(false);
  }
}

/* ---------- Utilities ---------- */
function clearMessages(){ messageEl.textContent=''; errorEl.textContent=''; successEl.textContent=''; }
function showMessage(msg){ messageEl.textContent = msg; errorEl.textContent=''; successEl.textContent=''; }
function showError(msg){ errorEl.textContent = msg; messageEl.textContent=''; successEl.textContent=''; }
function showSuccess(msg){ successEl.textContent = msg; messageEl.textContent=''; errorEl.textContent=''; }

function setProgress(pct){ bar.style.width = pct + '%'; progress.style.display = (pct>=100||pct<=0)?'none':'block'; }
function setProgressVisible(v){ progress.style.display = v ? 'block' : 'none'; if(!v) bar.style.width='0%'; }

function downloadBlob(url, filename){
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  // Keep URL alive for "Download again" until clear or new process
}

/* build a usable filename using Content-Disposition or fallback */
function guessOutputFilename(origName, targetFormatFromUI, contentDisposition){
  let filename = '';
  const m = contentDisposition.match(/filename="?([^"]+)"?/);
  if (m && m[1]) filename = m[1];
  if (!filename) {
    const base = origName.replace(/\.[^/.]+$/,'');
    const ext = targetFormatFromUI || origName.split('.').pop() || 'bin';
    filename = base + '.' + ext;
  }
  // remove .bin if present unnecessarily
  filename = filename.replace(/\.bin$/i, '');
  return filename;
}

/* convert blob->text */
async function blobToText(b){ try { return await new Response(b).text(); } catch(e){ return ''; } }

/* get edited image blob from canvas, applying crop if necessary */
async function getEditedImageBlob(){
  if (canvas.style.display === 'none') return null;
  // apply crop extraction if requested
  let mimeType = selectedFile ? selectedFile.type : 'image/png';
  // if user selected targetFormat that is image, prefer that mime
  const t = targetFormat.value;
  if (t && ['jpeg','jpg','png','webp','avif','svg'].includes(t)) {
    mimeType = (t === 'jpeg' ? 'image/jpeg' : (t === 'jpg' ? 'image/jpeg' : 'image/'+t));
  }
  const edits = editsState; // current edits
  // if crop present, use offscreen canvas to extract area
  if (edits.crop) {
    const c = edits.crop;
    const off = document.createElement('canvas');
    off.width = c.width; off.height = c.height;
    const octx = off.getContext('2d');
    // copy from main canvas area
    octx.drawImage(canvas, c.left, c.top, c.width, c.height, 0,0, c.width, c.height);
    return await new Promise(res=> off.toBlob(b=>res(b), mimeType, Math.max(0.03, (parseInt(qualityEl.value)||80)/100)));
  } else {
    return await new Promise(res=> canvas.toBlob(b=>res(b), mimeType, Math.max(0.03, (parseInt(qualityEl.value)||80)/100)));
  }
}

/* safe html escape for text previews */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* extract text preview from small blob */
async function textPreviewFromFile(file){
  try {
    const txt = await file.text();
    return txt.slice(0, 8000);
  } catch (e) {
    return '';
  }
}

/* guess binary or not */
function isPreviewableText(type, size){
  if (!type) return size < 200000;
  return type.startsWith('text/') || ['application/json','application/xml','application/javascript'].includes(type);
}

/* ---------- helper: convert image/canvas draw (initial draw done when selecting file) ---------- */
/* When original image loads we call renderImageToCanvas -> drawCanvasWithEdits handled earlier */

/* ---------- utility: read small data for docx attempt preview (not full docx parser) ---------- */
async function tryDocxPreview(file){
  // docx is zipped. Skip complex preview; just show file name
  return `<div class="small">Document: ${file.name}</div>`;
}

/* ---------- helper: get server health on load (non-blocking) */
(async function checkHealth(){
  try {
    const res = await fetch(BACKEND_HOST + '/api/tools/file/health');
    const j = await res.json();
    console.log('backend health', j);
  } catch(e){
    console.warn('health check failed', e);
  }
})();

</script>
</body>
</html>
                


